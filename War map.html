<!DOCTYPE html>
<html>
<head>
  <title>Senior Assassin Tactical Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 100vh; }
    #controlPanel {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      width: 220px;
      font-size: 14px;
    }
    input { width: 100%; margin-bottom: 5px; }
    button { width: 100%; margin-bottom: 5px; }
  </style>
</head>
<body>

<div id="controlPanel">
  <div id="mapControls">
    <b id="playerLabel"></b>
    <button onclick="logout()">Logout</button>
    <input id="markerTitleInput" placeholder="Marker title (optional)">
    <input id="markerColorInput" type="color" value="#ff0000">
    <button onclick="beginAddCustomMarker()">Add Marker</button>
    <div id="addMarkerStatus" style="font-size:12px;color:#555;margin-bottom:6px;"></div>
  </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script src="supabase-config.js"></script>

<script>
const sb = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

let session = null;
let currentUser = null;
let pendingCustomMarker = null;
let markersReloadHandle = null;

function scheduleReloadMarkers() {
  if (markersReloadHandle) clearTimeout(markersReloadHandle);
  markersReloadHandle = setTimeout(loadMarkers, 150);
}

function escapeHtml(text) {
  return String(text)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#39;');
}

async function logout() {
  await sb.auth.signOut();
  localStorage.removeItem('currentUser');
  window.location.href = 'login.html';
}

var map = L.map('map', { zoomControl: false }).setView([40.5853, -105.0844], 13); // Fort Collins

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let markersLayer = L.layerGroup().addTo(map);

async function initAuth() {
  const { data, error } = await sb.auth.getSession();
  if (error) {
    console.warn(error);
  }
  session = data.session;
  if (!session) {
    window.location.href = 'login.html';
    return;
  }

  currentUser = session.user?.user_metadata?.username || (session.user?.email ? session.user.email.split('@')[0] : '');
  localStorage.setItem('currentUser', currentUser);
  const label = document.getElementById('playerLabel');
  if (label) label.innerText = 'Logged in: ' + currentUser;
}

async function loadMarkers() {
  const { data, error } = await sb
    .from('markers')
    .select('id,user_id,username,title,color,lat,lng,created_at,updated_at')
    .order('created_at', { ascending: true });

  if (error) {
    console.warn(error);
    return;
  }

  markersLayer.clearLayers();

  (data || []).forEach((m) => {

    const icon = L.divIcon({
      className: "",
      html: `<div style="background:${m.color};width:14px;height:14px;border-radius:50%"></div>`
    });

    const marker = L.marker([m.lat, m.lng], { icon }).addTo(markersLayer);

    if (m.title && String(m.title).trim()) {
      marker.bindTooltip(escapeHtml(String(m.title).trim()), {
        permanent: true,
        direction: 'top',
        offset: [0, -6]
      });
    }

    const canEdit = session && m.user_id === session.user.id;
    const titleLine = m.title ? `<b>${escapeHtml(m.title)}</b><br>` : '';
    const who = m.username || '';
    const when = m.updated_at || m.created_at;
    marker.bindPopup(`
      ${titleLine}${escapeHtml(who)}<br>
      ${new Date(when).toLocaleString()}<br>
      ${canEdit ? `<button onclick="editMarker('${m.id}')">Edit</button>
      <button onclick="deleteMarker('${m.id}')">Delete</button>` : ''}
    `);
  });
}

function beginAddCustomMarker() {
  if (!currentUser) return (window.location.href = 'login.html');

  const title = (document.getElementById('markerTitleInput')?.value || '').trim();
  const color = (document.getElementById('markerColorInput')?.value || '#ff0000').trim();
  pendingCustomMarker = {
    title,
    color
  };

  const status = document.getElementById('addMarkerStatus');
  if (status) status.innerText = 'Click the map to place your markerâ€¦';
}

async function saveMarker(lat, lng, options = null) {
  if (!currentUser) {
    alert('Please login first');
    return false;
  }

  const chosenColor = (options && options.color) ? options.color : '#ff0000';
  const title = (options && typeof options.title === 'string') ? options.title : '';

  const { error } = await sb.from('markers').insert({
    user_id: session.user.id,
    username: currentUser,
    title,
    color: chosenColor,
    lat,
    lng
  });

  if (error) {
    console.warn(error);
    alert(error.message);
    return false;
  }

  scheduleReloadMarkers();
  const status = document.getElementById('addMarkerStatus');
  if (status) status.innerText = '';
  return true;
}

async function deleteMarker(id) {
  if (!session) return alert('Please login first');
  const { error } = await sb.from('markers').delete().eq('id', id);
  if (error) {
    console.warn(error);
    alert(error.message);
    return;
  }
  scheduleReloadMarkers();
}

async function editMarker(id) {
  if (!session) return alert("Please login first");
  const ok = confirm('Update timestamp to now?');
  if (!ok) return;

  const { error } = await sb
    .from('markers')
    .update({ updated_at: new Date().toISOString() })
    .eq('id', id);

  if (error) {
    console.warn(error);
    alert(error.message);
    return;
  }
  scheduleReloadMarkers();
}

map.on('click', async function(e) {
  if (pendingCustomMarker) {
    const ok = await saveMarker(e.latlng.lat, e.latlng.lng, pendingCustomMarker);
    if (ok) pendingCustomMarker = null;
    const status = document.getElementById('addMarkerStatus');
    if (status && !pendingCustomMarker) status.innerText = '';
    return;
  }
  // Markers are only placed after clicking "Add Marker".
});

async function initRealtime() {
  sb
    .channel('markers-changes')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'markers' }, () => {
      scheduleReloadMarkers();
    })
    .subscribe();
}

// boot
(async () => {
  await initAuth();
  await loadMarkers();
  await initRealtime();
})();


</script>
</body>
</html>