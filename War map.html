<!DOCTYPE html>
<html>
<head>
  <title>Senior Assassin Tactical Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height: 100%; }
    body {
      margin: 0;
      -webkit-text-size-adjust: 100%;
    }
    #map {
      height: 100vh;
      height: 100dvh; /* iOS dynamic viewport */
    }
    #controlPanel {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      width: 220px;
      font-size: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }
    #controlPanel.collapsed #menuBody {
      display: none;
    }
    #controlPanel.collapsed #addMarkerStatus {
      margin-bottom: 0;
    }
    input {
      width: 100%;
      margin-bottom: 8px;
      padding: 10px;
      box-sizing: border-box;
      font-size: 16px; /* prevents iOS Safari zoom */
    }
    textarea {
      width: 100%;
      margin-bottom: 8px;
      padding: 10px;
      box-sizing: border-box;
      font-size: 16px;
      resize: vertical;
    }
    button {
      width: 100%;
      margin-bottom: 8px;
      padding: 12px;
      font-size: 16px;
      touch-action: manipulation;
    }

    /* iPhone-friendly: move controls to bottom for easier reach */
    @media (max-width: 520px) {
      #controlPanel {
        top: auto;
        left: 50%;
        transform: translateX(-50%);
        bottom: calc(10px + env(safe-area-inset-bottom));
        width: calc(100vw - 20px);
        max-width: 520px;
        max-height: 36dvh;
        overflow: auto;
        padding: 8px;
        padding-bottom: calc(8px + env(safe-area-inset-bottom));
        font-size: 14px;
      }
      input, textarea {
        padding: 8px;
        font-size: 16px;
      }
      button {
        padding: 10px;
        font-size: 16px;
      }
    }
  </style>
</head>
<body>

<div id="controlPanel">
  <div id="mapControls">
    <div id="panelHeader" style="display:flex;align-items:center;gap:8px;">
      <b id="playerLabel" style="flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"></b>
      <button id="toggleMenuBtn" type="button" onclick="toggleMenu()" style="width:auto;margin-bottom:0;padding:8px 10px;">Hide</button>
    </div>
    <div id="addMarkerStatus" style="font-size:12px;color:#555;margin:6px 0 8px 0;"></div>

    <div id="menuBody">
      <button onclick="logout()">Logout</button>
      <input id="markerTitleInput" placeholder="Marker title (optional)">
      <textarea id="markerDescInput" placeholder="Description (optional)" rows="2"></textarea>
      <input id="markerColorInput" type="color" value="#ff0000">
      <button id="addMarkerBtn" onclick="beginAddCustomMarker()">Add Marker</button>
      <button id="saveEditsBtn" onclick="saveMarkerEdits()" style="display:none;">Save Changes</button>
      <button id="cancelEditsBtn" onclick="cancelMarkerEdits()" style="display:none;">Cancel Edit</button>

      <div style="margin:10px 0 6px 0;font-weight:700;">Color Key</div>
      <div id="colorKeyList"></div>
      <button id="addColorKeyBtn" type="button" onclick="addColorKey()">Add Key</button>
      <div id="colorKeyStatus" style="font-size:12px;color:#555;margin-top:6px;"></div>
    </div>
  </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script src="supabase-config.js?v=20260227-1"></script>

<script>
const APP_VERSION = '20260227-1';

// Helps Safari/GitHub Pages caching: ensure a version query exists.
(function ensureVersionQuery() {
  try {
    const url = new URL(window.location.href);
    if (!url.searchParams.get('v')) {
      url.searchParams.set('v', APP_VERSION);
      window.location.replace(url.toString());
    }
  } catch {
    // ignore
  }
})();

const sb = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

const LABEL_MIN_ZOOM = 5; // hide marker title labels when zoomed out below this

let session = null;
let currentUser = null;
let pendingCustomMarker = null;
let markersReloadHandle = null;
let markersById = new Map();
let editingMarkerId = null;
let didCenterOnFRHS = false;
let labelTooltips = [];
let colorKeyItems = [];

function setColorKeyStatus(text, isError = false) {
  const el = document.getElementById('colorKeyStatus');
  if (!el) return;
  el.style.color = isError ? '#b00020' : '#555';
  el.innerText = text || '';
}

function setMenuCollapsed(collapsed) {
  const panel = document.getElementById('controlPanel');
  if (!panel) return;
  if (collapsed) panel.classList.add('collapsed');
  else panel.classList.remove('collapsed');

  const btn = document.getElementById('toggleMenuBtn');
  if (btn) btn.innerText = collapsed ? 'Menu' : 'Hide';
}

function toggleMenu() {
  const panel = document.getElementById('controlPanel');
  if (!panel) return;
  setMenuCollapsed(!panel.classList.contains('collapsed'));
}

function setAddMarkerStatus(text, isError = false) {
  const status = document.getElementById('addMarkerStatus');
  if (!status) return;
  status.style.color = isError ? '#b00020' : '#555';
  status.innerText = text || '';
}

function scheduleReloadMarkers() {
  if (markersReloadHandle) clearTimeout(markersReloadHandle);
  markersReloadHandle = setTimeout(loadMarkers, 150);
}

function updateLabelVisibility() {
  const show = map.getZoom() >= LABEL_MIN_ZOOM;
  (labelTooltips || []).forEach((tt) => {
    if (!tt) return;
    try {
      if (typeof tt.setOpacity === 'function') tt.setOpacity(show ? 1 : 0);
      const el = (typeof tt.getElement === 'function') ? tt.getElement() : null;
      if (el) el.style.display = show ? '' : 'none';
    } catch {
      // ignore
    }
  });
}

function setEditMode(markerId) {
  editingMarkerId = markerId;
  pendingCustomMarker = null;

  const addBtn = document.getElementById('addMarkerBtn');
  const saveBtn = document.getElementById('saveEditsBtn');
  const cancelBtn = document.getElementById('cancelEditsBtn');
  if (addBtn) addBtn.style.display = markerId ? 'none' : '';
  if (saveBtn) saveBtn.style.display = markerId ? '' : 'none';
  if (cancelBtn) cancelBtn.style.display = markerId ? '' : 'none';

  if (markerId) {
    setAddMarkerStatus('Editing marker. Update fields then tap “Save Changes”.');
  } else {
    setAddMarkerStatus('');
  }
}

function cancelMarkerEdits() {
  editingMarkerId = null;
  setEditMode(null);
}

function escapeHtml(text) {
  return String(text)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#39;');
}

async function logout() {
  await sb.auth.signOut();
  localStorage.removeItem('currentUser');
  window.location.href = `login.html?v=${encodeURIComponent(APP_VERSION)}`;
}

var map = L.map('map', { zoomControl: false }).setView([40.5853, -105.0844], 13); // Fort Collins

map.on('zoomend', updateLabelVisibility);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let markersLayer = L.layerGroup().addTo(map);

async function initAuth() {
  const { data, error } = await sb.auth.getSession();
  if (error) {
    console.warn(error);
  }
  session = data.session;
  if (!session) {
    window.location.href = `login.html?v=${encodeURIComponent(APP_VERSION)}`;
    return;
  }

  currentUser = session.user?.user_metadata?.username || (session.user?.email ? session.user.email.split('@')[0] : '');
  localStorage.setItem('currentUser', currentUser);
  const label = document.getElementById('playerLabel');
  if (label) label.innerText = 'Logged in: ' + currentUser;
}

async function loadMarkers() {
  const { data, error } = await sb
    .schema('public')
    .from('markers')
    .select('id,user_id,username,title,description,color,lat,lng,created_at,updated_at')
    .order('created_at', { ascending: true });

  if (error) {
    console.warn(error);
    setAddMarkerStatus(`Failed to load markers: ${error.message}`, true);
    return;
  }

  // Clear any previous load errors once we succeed.
  setAddMarkerStatus('');

  markersLayer.clearLayers();

  markersById = new Map();
  labelTooltips = [];

  if (!didCenterOnFRHS) {
    const frhs = (data || []).find((m) => m && m.title === 'FRHS' && typeof m.lat === 'number' && typeof m.lng === 'number');
    if (frhs) {
      // Keep current zoom if user has one, otherwise a reasonable default.
      const z = typeof map?.getZoom === 'function' ? map.getZoom() : 13;
      map.setView([frhs.lat, frhs.lng], z, { animate: false });
      didCenterOnFRHS = true;
    }
  }

  (data || []).forEach((m) => {

    markersById.set(m.id, m);

    const icon = L.divIcon({
      className: "",
      html: `<div style="background:${m.color};width:14px;height:14px;border-radius:50%"></div>`
    });

    const marker = L.marker([m.lat, m.lng], { icon }).addTo(markersLayer);

    if (m.title && String(m.title).trim()) {
      marker.bindTooltip(escapeHtml(String(m.title).trim()), {
        permanent: true,
        direction: 'top',
        offset: [0, -6]
      });

      const tt = marker.getTooltip ? marker.getTooltip() : null;
      if (tt) labelTooltips.push(tt);
    }

    const canEdit = session && m.user_id === session.user.id;
    const titleLine = m.title ? `<b>${escapeHtml(m.title)}</b><br>` : '';
    const descLine = (m.description && String(m.description).trim()) ? `${escapeHtml(String(m.description).trim())}<br>` : '';
    const who = m.username || '';
    const when = m.updated_at || m.created_at;
    marker.bindPopup(`
      ${titleLine}${descLine}${escapeHtml(who)}<br>
      ${new Date(when).toLocaleString()}<br>
      ${canEdit ? `<button onclick="editMarker('${m.id}')">Edit</button>
      <button onclick="deleteMarker('${m.id}')">Delete</button>` : ''}
    `);
  });

  // Ensure visibility is correct after tooltips are attached
  setTimeout(updateLabelVisibility, 0);
}

async function loadColorKey() {
  const { data, error } = await sb
    .schema('public')
    .from('color_key')
    .select('id,label,color,created_at,updated_at')
    .order('label', { ascending: true });

  if (error) {
    console.warn(error);
    setColorKeyStatus(`Failed to load color key: ${error.message}`, true);
    return;
  }

  colorKeyItems = data || [];
  renderColorKey();
  setColorKeyStatus('');
}

function renderColorKey() {
  const host = document.getElementById('colorKeyList');
  if (!host) return;

  host.innerHTML = '';

  if (!colorKeyItems.length) {
    const empty = document.createElement('div');
    empty.style.fontSize = '12px';
    empty.style.color = '#555';
    empty.style.marginBottom = '8px';
    empty.innerText = 'No key entries yet.';
    host.appendChild(empty);
    return;
  }

  colorKeyItems.forEach((item) => {
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.gap = '8px';
    row.style.alignItems = 'center';
    row.style.marginBottom = '8px';

    const color = document.createElement('input');
    color.type = 'color';
    color.value = item.color || '#ff0000';
    color.style.width = '56px';
    color.style.padding = '0';
    color.style.height = '38px';

    const label = document.createElement('input');
    label.type = 'text';
    label.placeholder = 'Label';
    label.value = item.label || '';
    label.style.flex = '1';

    const del = document.createElement('button');
    del.type = 'button';
    del.innerText = 'Del';
    del.style.width = '64px';
    del.style.marginBottom = '0';
    del.onclick = () => deleteColorKey(item.id);

    const scheduleSave = () => upsertColorKey(item.id, label.value, color.value);
    label.onchange = scheduleSave;
    color.onchange = scheduleSave;

    row.appendChild(color);
    row.appendChild(label);
    row.appendChild(del);
    host.appendChild(row);
  });
}

async function addColorKey() {
  if (!session) {
    alert('Please login first');
    return;
  }

  const { data, error } = await sb
    .schema('public')
    .from('color_key')
    .insert({ label: 'New', color: '#ff0000' })
    .select('id,label,color,created_at,updated_at')
    .single();

  if (error) {
    console.warn(error);
    setColorKeyStatus(error.message, true);
    return;
  }

  colorKeyItems.push(data);
  renderColorKey();
}

async function upsertColorKey(id, label, color) {
  if (!session) return;

  const cleanLabel = String(label || '').trim();
  const cleanColor = String(color || '').trim() || '#ff0000';
  if (!cleanLabel) return;

  const { error } = await sb
    .schema('public')
    .from('color_key')
    .update({ label: cleanLabel, color: cleanColor, updated_at: new Date().toISOString() })
    .eq('id', id);

  if (error) {
    console.warn(error);
    setColorKeyStatus(error.message, true);
  }
}

async function deleteColorKey(id) {
  if (!session) return;
  const { error } = await sb.schema('public').from('color_key').delete().eq('id', id);
  if (error) {
    console.warn(error);
    setColorKeyStatus(error.message, true);
    return;
  }
  colorKeyItems = colorKeyItems.filter((x) => x.id !== id);
  renderColorKey();
}

function beginAddCustomMarker() {
  if (!currentUser) return (window.location.href = 'login.html');

  if (editingMarkerId) {
    setAddMarkerStatus('Finish editing (Save/Cancel) before adding a new marker.', true);
    return;
  }

  const title = (document.getElementById('markerTitleInput')?.value || '').trim();
  const description = (document.getElementById('markerDescInput')?.value || '').trim();
  const color = (document.getElementById('markerColorInput')?.value || '#ff0000').trim();
  pendingCustomMarker = {
    title,
    description,
    color
  };

  setAddMarkerStatus('Click the map to place your marker…');
}

async function editMarker(id) {
  if (!session) return alert('Please login first');

  let m = markersById.get(id);
  if (!m) {
    const { data, error } = await sb.schema('public').from('markers').select('id,user_id,username,title,description,color,lat,lng,created_at,updated_at').eq('id', id).maybeSingle();
    if (error) {
      console.warn(error);
      alert(error.message);
      return;
    }
    m = data;
  }

  if (!m) {
    alert('Marker not found. Try refreshing.');
    return;
  }

  if (m.user_id !== session.user.id) {
    alert('You can only edit your own markers.');
    return;
  }

  // Populate fields
  const titleEl = document.getElementById('markerTitleInput');
  const descEl = document.getElementById('markerDescInput');
  const colorEl = document.getElementById('markerColorInput');
  if (titleEl) titleEl.value = m.title || '';
  if (descEl) descEl.value = m.description || '';
  if (colorEl) colorEl.value = m.color || '#ff0000';

  setEditMode(id);
}

async function saveMarkerEdits() {
  if (!session) return alert('Please login first');
  if (!editingMarkerId) return;

  const m = markersById.get(editingMarkerId);
  if (m && m.user_id !== session.user.id) {
    alert('You can only edit your own markers.');
    return;
  }

  const title = (document.getElementById('markerTitleInput')?.value || '').trim();
  const description = (document.getElementById('markerDescInput')?.value || '').trim();
  const color = (document.getElementById('markerColorInput')?.value || '#ff0000').trim();

  setAddMarkerStatus('Saving changes…');
  const { error } = await sb
    .schema('public')
    .from('markers')
    .update({
      title,
      description,
      color,
      updated_at: new Date().toISOString()
    })
    .eq('id', editingMarkerId);

  if (error) {
    console.warn(error);
    const code = error.code ? ` (code ${error.code})` : '';
    setAddMarkerStatus(`Failed to save changes: ${error.message}${code}`, true);
    return;
  }

  setEditMode(null);
  scheduleReloadMarkers();
}

async function saveMarker(lat, lng, options = null) {
  if (!currentUser) {
    alert('Please login first');
    return false;
  }

  if (!session) {
    setAddMarkerStatus('Session expired. Please log in again.', true);
    window.location.href = `login.html?v=${encodeURIComponent(APP_VERSION)}`;
    return false;
  }

  const chosenColor = (options && options.color) ? options.color : '#ff0000';
  const title = (options && typeof options.title === 'string') ? options.title : '';
  const description = (options && typeof options.description === 'string') ? options.description : '';

  const { error } = await sb.schema('public').from('markers').insert({
    user_id: session.user.id,
    username: currentUser,
    title,
    description,
    color: chosenColor,
    lat,
    lng
  });

  if (error) {
    console.warn(error);
    const code = error.code ? ` (code ${error.code})` : '';
    const hintLines = [];
    if (String(error.message || '').toLowerCase().includes('row level security')) {
      hintLines.push('Hint: RLS denied this insert. Make sure you are logged in and ran supabase_setup.sql policies.');
    }
    if (String(error.message || '').toLowerCase().includes('relation') && String(error.message || '').toLowerCase().includes('does not exist')) {
      hintLines.push('Hint: Table missing. Run supabase_setup.sql in Supabase SQL Editor.');
    }
    const hint = hintLines.length ? `\n${hintLines.join('\n')}` : '';
    setAddMarkerStatus(`Failed to save marker: ${error.message}${code}${hint}`, true);
    return false;
  }

  scheduleReloadMarkers();
  setAddMarkerStatus('');
  return true;
}

async function deleteMarker(id) {
  if (!session) return alert('Please login first');
  if (editingMarkerId === id) setEditMode(null);
  const { error } = await sb.schema('public').from('markers').delete().eq('id', id);
  if (error) {
    console.warn(error);
    alert(error.message);
    return;
  }
  scheduleReloadMarkers();
}

map.on('click', async function(e) {
  if (pendingCustomMarker) {
    setAddMarkerStatus('Saving marker…');
    const ok = await saveMarker(e.latlng.lat, e.latlng.lng, pendingCustomMarker);
    if (ok) pendingCustomMarker = null;
    if (!pendingCustomMarker) setAddMarkerStatus('');
    return;
  }
  // Markers are only placed after clicking "Add Marker".
});

async function initRealtime() {
  sb
    .channel('markers-changes')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'markers' }, () => {
      scheduleReloadMarkers();
    })
    .on('postgres_changes', { event: '*', schema: 'public', table: 'color_key' }, () => {
      loadColorKey();
    })
    .subscribe();
}

// boot
(async () => {
  // Default to collapsed on small screens to show more map.
  try {
    if (window.matchMedia && window.matchMedia('(max-width: 520px)').matches) {
      setMenuCollapsed(true);
    }
  } catch {
    // ignore
  }
  await initAuth();
  await loadMarkers();
  await loadColorKey();
  await initRealtime();
})();


</script>
</body>
</html>